<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="boardDiv">

    </div>
    <button id="createNoteBtn">Create New Note</button>
    <button id="addUsersBtn">Add collaborators</button>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h2>Add new collaborator</h2>
            <span id="memberSpan"></span>
            <input type="text" id="memberEmail" placeholder="Email">
            <button id="addMemberBtn">Add</button>
            <button id="closeMemberBtn">Close</button>
        </div>
    </div>

</body>

</html>

<script>

    const urlParams = new URLSearchParams(window.location.search)
    const boardId = urlParams.get("board")
    const boardDiv = document.getElementById("boardDiv")

    const notesapi = "https://virtualboard-notes.onrender.com/notes/"
    const loginapi = "https://virtualboard-login.onrender.com/boards/"

    addUsersBtn.addEventListener("click", () => {
        document.getElementById("memberSpan").textContent = ""
        document.getElementById("modal").classList.remove("hidden")
    })

    document.getElementById("closeMemberBtn").addEventListener("click", () => {
        document.getElementById("modal").classList.add("hidden")
        document.getElementById("memberEmail").value = ""
        console.log("Modal closed")
    })

    document.getElementById("addMemberBtn").addEventListener("click", async () => {
        const email = document.getElementById("memberEmail").value.trim()
        if (email) {
            try {
                const response = await fetch(`${loginapi}${boardId}`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem("token")}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email })
                })
                if (!response.ok) {
                    throw new Error("Failed to add user")
                }
                await response.json()
                console.log("user added: " + email)
                document.getElementById("modal").classList.add("hidden")
                document.getElementById("memberEmail").value = ""
            } catch (error) {
                console.error("Error adding user:", error)
                document.getElementById("memberSpan").textContent = "Error adding user"
            }
        }
    })




    document.getElementById("createNoteBtn").addEventListener("click", () => {
        const centerX = parseInt(Math.random() * 20 + window.innerWidth / 2, 10)
        const centerY = parseInt(Math.random() * 20 + window.innerHeight / 2, 10)

        postNewNote(boardId, centerX, centerY)
    })


    async function fetchNotes() {
        try {
            const response = await fetch(`${notesapi}${boardId}`, {
                method: "GET",
            })
            const data = await response.json()
            console.log(data) 
            return data
        } catch (error) {
            console.error("Login failed:", error)
            return null
        }
    }

    async function postNewNote(boardId, x, y) {
        try {
            const response = await fetch(`${notesapi}${boardId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    content: "text here",
                    x_loc: x,
                    y_loc: y
                })
            })

            if (!response.ok) {
                throw new Error("Failed to create note")

            }

            const newNote = await response.json()
            console.log("Note created:", newNote)
            const notes = await fetchNotes()
            if (notes) {
                boardDiv.innerHTML = ""
                renderNotes(notes)
            }
            return newNote
        } catch (error) {
            console.error("Error creating note:", error)
        }

    }



    function renderNotes(notes) {
        const boardDiv = document.getElementById("boardDiv")
        boardDiv.innerHTML = ""

        notes.forEach(note => {
            const noteDiv = document.createElement("div")
            noteDiv.className = "note"
            noteDiv.style.position = "absolute"
            noteDiv.style.left = note.x_loc + "px"
            noteDiv.style.top = note.y_loc + "px"
            noteDiv.style.width = "150px"
            noteDiv.style.minHeight = "40px"
            noteDiv.style.padding = "10px"
            noteDiv.style.background = "#fffa"
            noteDiv.style.border = "1px solid #ccc"
            noteDiv.style.cursor = "grab"
            noteDiv.style.boxSizing = "border-box"
            noteDiv.style.backgroundColor = note.title + "aa"
            noteDiv.setAttribute("data-id", note.id)
           

            const content = document.createElement("div")
            content.textContent = note.content
            content.style.marginRight = "20px"
            noteDiv.appendChild(content)

            content.addEventListener("dblclick", () => {
                const input = document.createElement("textarea")
                input.value = content.textContent
                input.style.width = "100%"
                input.style.height = "50px"
                input.style.boxSizing = "border-box"

                noteDiv.replaceChild(input, content)
                input.focus()

                function saveEdit() {
                    const newText = input.value.trim()
                    patchNoteText(note.id, newText)
                    content.textContent = newText
                    noteDiv.replaceChild(content, input)
                }

                input.addEventListener("blur", saveEdit)
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault()
                        saveEdit()
                    }
                })
            })

            const deleteBtn = document.createElement("button")
            deleteBtn.textContent = "âœ–"
            deleteBtn.style.position = "absolute"
            deleteBtn.style.top = "2px"
            deleteBtn.style.right = "2px"
            deleteBtn.style.border = "none"
            deleteBtn.style.background = "transparent"
            deleteBtn.style.cursor = "pointer"
            deleteBtn.style.color = "red"
            deleteBtn.style.fontWeight = "bold"

            deleteBtn.addEventListener("click", (e) => {
                e.stopPropagation()
                deleteNote(note.id, noteDiv)
            })

            noteDiv.appendChild(deleteBtn)

            const colorContainer = document.createElement("div")
            colorContainer.style.position = "absolute"
            colorContainer.style.top = "2px"
            colorContainer.style.left = "2px"
            colorContainer.style.display = "flex"
            colorContainer.style.gap = "4px"
            colorContainer.style.zIndex = "2"

            const colors = ["#f39c12", "#27ae60", "#8e44ad"]

            colors.forEach(color => {
                const colorBtn = document.createElement("button")
                colorBtn.style.backgroundColor = color
                colorBtn.style.width = "16px"
                colorBtn.style.height = "16px"
                colorBtn.style.border = "none"
                colorBtn.style.borderRadius = "50%"
                colorBtn.style.cursor = "pointer"
                colorBtn.style.margin = "0"
                colorBtn.addEventListener("click", (e) => {
                    e.stopPropagation()
                    noteDiv.style.background = color + "aa"
                    patchNoteColor(note.id, color)
                })
                colorContainer.appendChild(colorBtn)
            })

            noteDiv.appendChild(colorContainer)

            boardDiv.appendChild(noteDiv)

            makeDraggable(noteDiv)
        })
    }


    fetchNotes().then(notes => {
        if (notes) {
            renderNotes(notes)
        }
    })

    function makeDraggable(el) {
        let posX, posY

        el.addEventListener("mousedown", (e) => {
            posX = e.clientX - el.offsetLeft
            posY = e.clientY - el.offsetTop
            el.style.cursor = "grabbing"

            function onMouseMove(e) {
                el.style.left = e.clientX - posX + "px"
                el.style.top = e.clientY - posY + "px"
            }

            function onMouseUp() {
                el.style.cursor = "grab"
                document.removeEventListener("mousemove", onMouseMove)
                document.removeEventListener("mouseup", onMouseUp)

                const noteId = el.getAttribute("data-id")
                patchNotePosition(noteId, el.offsetLeft, el.offsetTop)
            }

            document.addEventListener("mousemove", onMouseMove)
            document.addEventListener("mouseup", onMouseUp)
        })
    }

    async function patchNotePosition(id, x, y) {
        try {
            const response = await fetch(`${notesapi}${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    x_loc: x,
                    y_loc: y
                }),
            })

            if (!response.ok) {
                throw new Error("Failed to update note position")
            }

            console.log(`Note ${id} position updated to (${x}, ${y})`)
        } catch (err) {
            console.error("Error updating note:", err)
        }
    }

    async function patchNoteText(id, newText) {
        try {
            const response = await fetch(`${notesapi}${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: newText })
            })

            if (!response.ok) {
                throw new Error("Failed to update note text")
            }

            console.log(`Note ${id} text updated: "${newText}"`)
        } catch (err) {
            console.error("Error updating text:", err)
        }
    }

    async function patchNoteColor(id, color) {
         try {
            const response = await fetch(`${notesapi}${id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color: color })
            })

            if (!response.ok) {
                throw new Error("Failed to update note color")
            }

            console.log(`Note ${id} color updated: "${color}"`)
        } catch (err) {
            console.error("Error updating color:", err)
        }
    }

    async function deleteNote(id, noteDiv) {
        try {
            const response = await fetch(`${notesapi}${id}`, {
                method: "DELETE"
            })

            if (!response.ok) {
                throw new Error("Failed to delete note")
            }

            noteDiv.remove()
            console.log(`Note ${id} deleted`)
        } catch (err) {
            console.error("Error deleting note:", err)
        }
    }


    setInterval(() => {
        fetchNotes().then(notes => {
            if (notes) {
                renderNotes(notes)
            }
        })
    }, 5000)

</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .hidden {
        display: none;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .modal-content input {
        padding: 0.5rem;
        font-size: 1rem;
    }

    #memberSpan {
        color: red;
    }
</style>